<!DOCTYPE html>
<html lang="en">
<head>
<title>ACE in Action</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 50%;
        bottom: 0;
        left: 0;
    }
</style>
    <script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="ace/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
<!-- script src="lib/mode-dyndoc.js" type="text/javascript" charset="utf-8"></script-->
<!--script src="lib/snippets/dyndoc.js" type="text/javascript" charset="utf-8"></script-->

</head>
<body>

<input style="display:none;" id="openDialog" type="file" />
<div id="container">
<div id="editor"></div>
</div>
<iframe src="pdf.js/web/viewer.html" style="position: absolute;top:0;left:50%;right:0;bottom:0;width:50%;height:100%"></iframe>
<script>
    var gui = require('nw.gui');
    var fs = require("fs");
    var path = require("path");
    var exec = require('child_process').exec;

    ace.require("ace/ext/language_tools");

    function initFile(filename,old) {
        win.currentFile=filename;
        win.basename=path.basename(win.currentFile);
        win.dirname=path.dirname(win.currentFile);
        
        //pdf
        if(typeof(old) === 'undefined') {
            win.oldPdf=win.currentPdf;
        }
        win.currentPdf=path.join(win.dirname,path.basename(win.currentFile, path.extname(win.currentFile)))+'.pdf';
        //unwatch
        if(typeof(old) === 'undefined') {
            fs.unwatchFile(win.oldPdf);
        }
        //watch
        fs.watchFile(win.currentPdf, function(curr,prev) {
            console.log(win.currentPdf + " updated!");
            if(win.pdf[win.currentPdf]) win.pdf[win.currentPdf].close();
                win.pdf[win.currentPdf]=gui.Window.open("pdf.js/web/viewer.html?file="+win.currentPdf+"?time="+Math.random());
            //exec("open "+win.currentPdf);
        })
    }

    var win={pdf: {}};
    var editor = ace.edit("editor");
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true
    });
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/dyndoc");
    initFile(gui.App.argv[0],false);
    editor.getSession().setValue(fs.readFileSync(win.currentFile, "utf8"));

    function chooseFile(name) {
        var chooser = document.querySelector(name);
        chooser.addEventListener("change", function(evt) {
            // open
            if (name=="#openDialog") {
                initFile(this.value);
                console.log("open "+win.currentFile);
                editor.getSession().setValue(fs.readFileSync(win.currentFile, "utf8"));
                // //unwatch
                // fs.unwatchFile(win.oldPdf);
                // //watch
                // fs.watchFile(win.currentPdf, function(curr,prev) {
                //     console.log(win.currentPdf + " updated!");
                //     // if(!win.pdf[win.currentPdf]) {
                //     //     win.pdf[win.currentPdf]=gui.Window.open("pdf.js/viewer.html");
                //     // }
                //     exec("open "+win.currentPdf);
                // })
            }
            // other here
        }, false);
        chooser.click();        
    }

    editor.commands.addCommand({
        name: 'save',
        bindKey: {mac: "Command-S", win: "Ctrl-S"},
        exec: function(editor) {
            var data = editor.getSession().getValue(); //.replace(/\n/g,"\r\n");
            fs.writeFileSync(win.currentFile, data, "utf8");
            console.log("save "+win.currentFile);
        }
    })

    editor.commands.addCommand({
        name: 'open',
        bindKey: {mac: "Command-O", win: "Ctrl-O"},
        exec: function(editor) {
            chooseFile("#openDialog");
        }
    })


    editor.commands.addCommand({
        name: 'dyndoc',
        bindKey: {mac: "Command-X", win: "Ctrl-X"},
        exec: function(editor) {
            console.log("dir: "+win);
            process.chdir(win.dirname);
            var cmd="dyndoc-ruby all -cspdf "+win.basename;
            exec(cmd,function (error, stdout, stderr) {
               var result = '{"stdout":' + stdout + ',"stderr":"' + stderr + '","cmd":"' + cmd + '"}';
               console.log(result + '\n');
            })
        }
    })
     
</script>
  
</body>
</html>